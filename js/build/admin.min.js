!function(e){"use strict";window.WellKnownFileManager=window.WellKnownFileManager||{},e.extend(window.WellKnownFileManager,{constructor(){this.nonce=window.WellKnownFileManager.nonce,this.bindEvents()},bindEvents(){e(".well-known-file-toggle").on("change",this.handleToggle.bind(this)),e(".save-file-content").on("click",this.handleSave.bind(this)),e(".restore-default-content").on("click",this.handleRestore.bind(this)),e(".well-known-file-content textarea").on("input",this.handleContentChange.bind(this)),e(".redirect-url-input").on("input",this.handleRedirectUrlChange.bind(this)),e(".well-known-file-link").on("mouseover focus",this.handleFileLinkClick.bind(this)),e(".well-known-file-link").on("mouseout blur",this.handleFileLinkMouseOut.bind(this))},handleContentChange(n){e(n.target).closest(".well-known-file-card")},handleRedirectUrlChange(n){e(n.target).closest(".well-known-file-card")},handleFileLinkClick(n){const t=e(n.target),a=t.data("original-href")||t.attr("href");t.data("original-href")||t.data("original-href",a);const s=a+(a.includes("?")?"&":"?")+"_t="+Date.now();t.attr("href",s)},handleFileLinkMouseOut(n){const t=e(n.target),a=t.data("original-href");a&&t.attr("href",a)},showSaveNotice(n,t){n.find(".card-notice.save").remove();const a=e("<div>",{class:"card-notice success save"});a.append(e("<span>",{text:t}));const s=e("<button>",{class:"card-notice-dismiss",type:"button","aria-label":"Dismiss notice"});a.append(s),n.append(a),s.on("click",(function(){a.fadeOut(300,(function(){e(this).remove()}))})),setTimeout((()=>{a.parent().length&&a.fadeOut(300,(function(){e(this).remove()}))}),3e3)},handleSave(n){const t=e(n.target).closest(".save-file-content"),a=t.closest(".well-known-file-card"),s=a.find(".well-known-file-toggle"),i=a.find(".well-known-file-response-code-input"),o=a.data("file-id");if(a.hasClass("saving"))return;a.addClass("saving"),t.prop("disabled",!0);const l=a.find(".redirect-url-input");if(l.length>0){const e=l.val();this.saveRedirectFile(o,e,s.is(":checked")).then((()=>{a.removeClass("saving"),t.prop("disabled",!1)})).catch((()=>{a.removeClass("saving"),t.prop("disabled",!1)}))}else{const e=a.find(".well-known-file-content textarea").val();this.saveFileContent(o,e,s.is(":checked"),i.val()).then((()=>{a.removeClass("saving"),t.prop("disabled",!1)})).catch((()=>{a.removeClass("saving"),t.prop("disabled",!1)}))}},handleToggle(n){const t=e(n.target),a=t.closest(".well-known-file-card"),s=a.find(".well-known-file-response-code-input"),i=a.data("file-id");if(a.hasClass("saving"))return;a.addClass("saving"),t.prop("disabled",!0);const o=a.find(".redirect-url-input");if(o.length>0){const e=o.val();t.is(":checked")?o.prop("disabled",!1):o.prop("disabled",!0),this.saveRedirectFile(i,e,t.is(":checked")).then((()=>{a.removeClass("saving"),t.prop("disabled",!1)})).catch((()=>{a.removeClass("saving"),t.prop("disabled",!1)}))}else{const e=a.find(".well-known-file-content textarea"),n=e.val();t.is(":checked")?e.prop("disabled",!1):e.prop("disabled",!0),this.saveFileContent(i,n,t.is(":checked"),s.val()).then((()=>{a.removeClass("saving"),t.prop("disabled",!1)})).catch((()=>{a.removeClass("saving"),t.prop("disabled",!1)}))}},handleRestore(n){const t=e(n.target).closest(".restore-default-content"),a=t.closest(".well-known-file-card"),s=a.data("file-id");if(a.hasClass("saving"))return;a.addClass("saving"),t.prop("disabled",!0);const i=a.find(".redirect-url-input");if(i.length>0){const e=WellKnownFileManager.lostPasswordUrl||"/wp-login.php?action=lostpassword";i.val(e),console.log("Restoring redirect file:",s,"with URL:",e),this.saveRedirectFile(s,e,!0).then((e=>{console.log("Redirect file restore success:",e),this.showSaveNotice(a,"Default redirect URL restored and saved."),a.removeClass("saving"),t.prop("disabled",!1)})).catch((e=>{console.error("Redirect file restore error:",e),this.showCardNotice(a,"error","Failed to save restored redirect URL."),a.removeClass("saving"),t.prop("disabled",!1)}))}else{const n=a.find(".well-known-file-content textarea");e.ajax({url:WellKnownFileManager.ajaxurl,type:"POST",data:{action:"wkfm_get_default_content",file_id:s,nonce:WellKnownFileManager.nonce},success:e=>{e.success?(n.val(e.data.content),this.saveFileContent(s,e.data.content,!0,e.data.response_code).then((()=>{this.showSaveNotice(a,"Default content restored and saved.")})).catch((()=>{this.showCardNotice(a,"error","Failed to save restored content.")}))):this.showCardNotice(a,"error","Failed to restore default content.")},error:()=>{this.showCardNotice(a,"error","Failed to restore default content.")},complete:()=>{a.removeClass("saving"),t.prop("disabled",!1)}})}},saveRedirectFile(n,t,a){return e.ajax({url:WellKnownFileManager.ajaxurl,type:"POST",data:{action:"wkfm_save_redirect_file",nonce:WellKnownFileManager.nonce,file:n,redirect_url:t,status:a}}).then((t=>{if(t.success){const s=e(`.well-known-file-card[data-file-id="${n}"]`),i=(s.find(".well-known-file-toggle"),s.find(".button"));return a?(s.removeClass("disabled"),i.prop("disabled",!1)):(s.addClass("disabled"),i.prop("disabled",!0)),this.showSaveNotice(s,t.data.message),t}throw new Error(t.data.message)}))},saveFileContent(n,t,a,s){return console.log("Sending nonce:",window.WellKnownFileManager.nonce),e.ajax({url:WellKnownFileManager.ajaxurl,type:"POST",data:{action:"wkfm_save_file",nonce:WellKnownFileManager.nonce,file:n,content:t,status:a,response_code:s}}).then((t=>{if(!t.success)throw new Error(t.data.message);{const s=e(`.well-known-file-card[data-file-id="${n}"]`),i=s.find(".well-known-file-content textarea"),o=(s.find(".well-known-file-toggle"),s.find(".button"));a?(s.removeClass("disabled"),i.prop("disabled",!1),o.prop("disabled",!1)):(s.addClass("disabled"),i.prop("disabled",!0),o.prop("disabled",!0)),this.showSaveNotice(s,t.data.message)}}))},showCardNotice(n,t,a){n.find(".card-notice").remove();const s=e("<div>",{class:`card-notice ${t}`});s.append(e("<span>",{text:a}));const i=e("<button>",{class:"card-notice-dismiss",type:"button","aria-label":"Dismiss notice"});s.append(i),n.append(s),i.on("click",(function(){s.fadeOut(300,(function(){e(this).remove()}))})),setTimeout((()=>{s.parent().length&&s.fadeOut(300,(function(){e(this).remove()}))}),3e3)},showNotice(e,n){const t=document.createElement("div");t.className=`notice notice-${e} is-dismissible`,t.innerHTML=`<p>${n}</p>`;const a=document.querySelector(".well-known-file-manager-admin");a&&(a.insertBefore(t,a.firstChild),setTimeout((()=>{t.parentNode&&t.remove()}),5e3))}}),e(document).ready((function(){window.WellKnownFileManager.constructor()}))}(jQuery);